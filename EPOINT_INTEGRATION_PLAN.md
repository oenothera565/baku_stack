# üí≥ ePoint Payment Integration Plan

–î–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã ePoint –≤ Baku Stack.

---

## üìã –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

- ‚úÖ **–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞**: ePoint (–ê–∑–µ—Ä–±–∞–π–¥–∂–∞–Ω)
- ‚úÖ **–ú–æ–¥–µ–ª—å –æ–ø–ª–∞—Ç—ã**: –ü—Ä–æ—Å—Ç–∞—è (–æ–ø–ª–∞—Ç–∞ ‚Üí –¥–æ—Å—Ç—É–ø)
- ‚úÖ **–í–∞–ª—é—Ç—ã**: AZN (–º–∞–Ω–∞—Ç) –∏ USD (–¥–æ–ª–ª–∞—Ä)
- ‚è≥ **API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: –û–∂–∏–¥–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- ‚úÖ **–ë–î —Å—Ö–µ–º–∞**: –ì–æ—Ç–æ–≤–∞ (`supabase-payments-schema.sql`)
- ‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞**: –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ (`lib/epoint.ts`)

---

## üéØ Workflow –æ–ø–ª–∞—Ç—ã

```
1. –°—Ç—É–¥–µ–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—Ç –∫—É—Ä—Å ‚Üí –Ω–∞–∂–∏–º–∞–µ—Ç "Enroll"
   ‚Üì
2. –ï—Å–ª–∏ course.price > 0 ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /payment/[courseId]
   ‚Üì
3. –°—Ç—É–¥–µ–Ω—Ç –≤—ã–±–∏—Ä–∞–µ—Ç –≤–∞–ª—é—Ç—É (AZN/USD)
   ‚Üì
4. –ö–ª–∏–∫ "Pay" ‚Üí POST /api/payments/create
   ‚Üì
5. Backend —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ DB (status: pending)
   ‚Üì
6. Backend –≤—ã–∑—ã–≤–∞–µ—Ç ePoint API ‚Üí –ø–æ–ª—É—á–∞–µ—Ç payment_url
   ‚Üì
7. –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ payment_url (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ ePoint –¥–ª—è –≤–≤–æ–¥–∞ –∫–∞—Ä—Ç—ã)
   ‚Üì
8. –°—Ç—É–¥–µ–Ω—Ç –≤–≤–æ–¥–∏—Ç –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã –∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç
   ‚Üì
9. ePoint –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç webhook ‚Üí POST /api/payments/webhook
   ‚Üì
10. Backend –ø—Ä–æ–≤–µ—Ä—è–µ—Ç signature
    ‚Üì
11. –û–±–Ω–æ–≤–ª—è–µ—Ç payment status ‚Üí 'completed'
    ‚Üì
12. –°–æ–∑–¥–∞–µ—Ç enrollment ‚Üí —Å—Ç—É–¥–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø
    ‚Üì
13. –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /payment/success
```

---

## üóÑÔ∏è –ß—Ç–æ —É–∂–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–æ

### 1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª**: `supabase-payments-schema.sql`

**–¢–∞–±–ª–∏—Ü—ã**:
- ‚úÖ `payments` - –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–µ–π
- ‚úÖ `enrollments` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `payment_id`
- ‚úÖ `courses` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `price_usd`

**–§—É–Ω–∫—Ü–∏–∏**:
- ‚úÖ `get_student_payment_summary()` - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π —Å—Ç—É–¥–µ–Ω—Ç–∞
- ‚úÖ `is_course_paid()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—á–µ–Ω –ª–∏ –∫—É—Ä—Å

**RLS Policies**:
- ‚úÖ –°—Ç—É–¥–µ–Ω—Ç—ã –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –ø–ª–∞—Ç–µ–∂–∏
- ‚úÖ –ò–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä—ã –≤–∏–¥—è—Ç –ø–ª–∞—Ç–µ–∂–∏ –∑–∞ —Å–≤–æ–∏ –∫—É—Ä—Å—ã

### 2. API Integration Layer

**–§–∞–π–ª**: `lib/epoint.ts`

**–§—É–Ω–∫—Ü–∏–∏ (–∑–∞–≥–ª—É—à–∫–∏)**:
- `createPayment()` - —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂
- `checkPaymentStatus()` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
- `verifyWebhookSignature()` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å webhook
- `convertCurrency()` - –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è AZN ‚Üî USD

### 3. Environment Variables

**–§–∞–π–ª**: `.env.example`

```env
EPOINT_API_URL=https://api.epoint.az
EPOINT_MERCHANT_ID=your-merchant-id
EPOINT_SECRET_KEY=your-secret-key
```

---

## üìù TODO: –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

### Phase 1: –ò–∑—É—á–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ (1-2 —á–∞—Å–∞)

- [ ] –ü—Ä–æ—á–∏—Ç–∞—Ç—å ePoint API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- [ ] –ù–∞–π—Ç–∏:
  - Endpoint –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞
  - –§–æ—Ä–º–∞—Ç webhook payload
  - –ú–µ—Ç–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ signature
  - Sandbox credentials –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
- [ ] –ü–æ–ª—É—á–∏—Ç—å test credentials

### Phase 2: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è API (3-4 —á–∞—Å–∞)

- [ ] **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `createPayment()` –≤ `lib/epoint.ts`**:
  - –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π request format
  - –ì–µ–Ω–µ—Ä–∞—Ü–∏—è signature
  - Error handling

- [ ] **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `verifyWebhookSignature()`**:
  - –ü—Ä–æ–≤–µ—Ä–∫–∞ HMAC/SHA256 (–∏–ª–∏ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ ePoint)
  - –ó–∞—â–∏—Ç–∞ –æ—Ç replay attacks

- [ ] **–°–æ–∑–¥–∞—Ç—å API endpoints**:
  - `app/api/payments/create/route.ts` - —Å–æ–∑–¥–∞—Ç—å –ø–ª–∞—Ç–µ–∂
  - `app/api/payments/webhook/route.ts` - –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å callback
  - `app/api/payments/status/[orderId]/route.ts` - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å

### Phase 3: UI Pages (2-3 —á–∞—Å–∞)

- [ ] **–°–æ–∑–¥–∞—Ç—å `/payment/[courseId]` page**:
  - –ü–æ–∫–∞–∑ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫—É—Ä—Å–µ
  - –í—ã–±–æ—Ä –≤–∞–ª—é—Ç—ã (AZN/USD)
  - –ö–Ω–æ–ø–∫–∞ "Pay Now"
  - –ü–æ–∫–∞–∑ —Ü–µ–Ω—ã –≤ –æ–±–µ–∏—Ö –≤–∞–ª—é—Ç–∞—Ö

- [ ] **–°–æ–∑–¥–∞—Ç—å `/payment/success` page**:
  - Congratulations message
  - –°—Å—ã–ª–∫–∞ –Ω–∞ /dashboard
  - –°—Å—ã–ª–∫–∞ –Ω–∞ /courses/[slug]/learn

- [ ] **–°–æ–∑–¥–∞—Ç—å `/payment/cancel` page**:
  - "Payment cancelled" message
  - –ö–Ω–æ–ø–∫–∞ "Try Again"

### Phase 4: –û–±–Ω–æ–≤–∏—Ç—å Enroll Flow (1-2 —á–∞—Å–∞)

- [ ] **–û–±–Ω–æ–≤–∏—Ç—å `app/courses/[slug]/page.tsx`**:
  - –í–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ enrollment ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ payment page
  - –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ü–µ–Ω—É –≤ AZN –∏ USD
  - –î–æ–±–∞–≤–∏—Ç—å "Free" badge –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö –∫—É—Ä—Å–æ–≤

- [ ] **–û–±–Ω–æ–≤–∏—Ç—å `lib/supabase.ts`**:
  - –î–æ–±–∞–≤–∏—Ç—å payment query functions
  - `createPaymentRecord()`
  - `updatePaymentStatus()`
  - `getStudentPayments()`

### Phase 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (2-3 —á–∞—Å–∞)

- [ ] **Sandbox —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
  - –°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å webhook
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–ø–µ—à–Ω—É—é –æ–ø–ª–∞—Ç—É
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–º–µ–Ω—É –ø–ª–∞—Ç–µ–∂–∞
  - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å failed payment

- [ ] **E2E —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
  - User —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è
  - –í—ã–±–∏—Ä–∞–µ—Ç –∫—É—Ä—Å
  - –û–ø–ª–∞—á–∏–≤–∞–µ—Ç
  - –ü–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø
  - –í–∏–¥–∏—Ç –≤ dashboard

### Phase 6: Production (1-2 —á–∞—Å–∞)

- [ ] –ü–æ–ª—É—á–∏—Ç—å production credentials –æ—Ç ePoint
- [ ] –û–±–Ω–æ–≤–∏—Ç—å `.env.local` –Ω–∞ production
- [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å webhook URL –≤ ePoint dashboard
- [ ] –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–ª–∞—Ç–µ–∂–µ–π
- [ ] –î–æ–±–∞–≤–∏—Ç—å email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:

- ‚úÖ –ù–∏–∫–æ–≥–¥–∞ –Ω–µ —Ö—Ä–∞–Ω–∏–º –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç (—ç—Ç–æ –¥–µ–ª–∞–µ—Ç ePoint)
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º webhook signature
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º HTTPS –¥–ª—è –≤—Å–µ—Ö endpoints
- ‚úÖ –•—Ä–∞–Ω–∏–º secret key —Ç–æ–ª—å–∫–æ –≤ .env (–Ω–µ –≤ –∫–æ–¥–µ)
- ‚úÖ –õ–æ–≥–∏—Ä—É–µ–º –≤—Å–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
- ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º amount –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º enrollment

---

## üí∞ –ü—Ä–∏–º–µ—Ä—ã —Ü–µ–Ω –∫—É—Ä—Å–æ–≤

| –ö—É—Ä—Å | –¶–µ–Ω–∞ AZN | –¶–µ–Ω–∞ USD | –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å |
|------|----------|----------|--------------|
| Frontend | 1699 ‚Çº | 999 $ | 4 –º–µ—Å—è—Ü–∞ |
| Backend | 2039 ‚Çº | 1199 $ | 5 –º–µ—Å—è—Ü–µ–≤ |
| QA | 1529 ‚Çº | 899 $ | 3 –º–µ—Å—è—Ü–∞ |
| DevOps | 2209 ‚Çº | 1299 $ | 5 –º–µ—Å—è—Ü–µ–≤ |
| UX/UI | 1359 ‚Çº | 799 $ | 3 –º–µ—Å—è—Ü–∞ |
| Mobile | 1869 ‚Çº | 1099 $ | 4 –º–µ—Å—è—Ü–∞ |

_(–ö—É—Ä—Å: 1 USD ‚âà 1.7 AZN, –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∏–∑ API)_

---

## üß™ –¢–µ—Å—Ç–æ–≤—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏

### 1. –£—Å–ø–µ—à–Ω–∞—è –æ–ø–ª–∞—Ç–∞
```
1. Login as test user
2. Go to /courses/frontend
3. Click "ENROLL NOW"
4. Select currency: AZN
5. Click "Pay 1699 ‚Çº"
6. Redirect to ePoint
7. Use test card: 4111111111111111
8. Payment success
9. Redirect to /payment/success
10. Check /dashboard - course appears
11. Check /courses/frontend/learn - video plays
```

### 2. –û—Ç–º–µ–Ω–∞ –ø–ª–∞—Ç–µ–∂–∞
```
1. Start payment flow
2. Click "Cancel" on ePoint page
3. Redirect to /payment/cancel
4. Payment status in DB: 'failed'
5. No enrollment created
```

### 3. Webhook failure
```
1. Payment succeeds in ePoint
2. Webhook fails (network error)
3. Manual check status API call
4. Update payment and create enrollment
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:

- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–ª–∞—Ç–µ–∂–µ–π –∑–∞ –¥–µ–Ω—å/–Ω–µ–¥–µ–ª—é/–º–µ—Å—è—Ü
- –°—Ä–µ–¥–Ω—è—è —Å—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞
- Conversion rate (visits ‚Üí payments)
- Failed payments ratio
- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∫—É—Ä—Å—ã
- –ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–∞—è –≤–∞–ª—é—Ç–∞ (AZN vs USD)

---

## üöÄ Quick Start (–ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)

```bash
# 1. –î–æ–±–∞–≤–∏—Ç—å credentials –≤ .env.local
EPOINT_MERCHANT_ID=xxx
EPOINT_SECRET_KEY=xxx

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å SQL schema
# –í Supabase SQL Editor –∑–∞–ø—É—Å—Ç–∏—Ç—å supabase-payments-schema.sql

# 3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏ –≤ lib/epoint.ts
# (–∑–∞–ø–æ–ª–Ω–∏—Ç—å TODOs —Å–æ–≥–ª–∞—Å–Ω–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏)

# 4. –°–æ–∑–¥–∞—Ç—å API endpoints
# app/api/payments/create/route.ts
# app/api/payments/webhook/route.ts

# 5. –°–æ–∑–¥–∞—Ç—å UI pages
# app/payment/[courseId]/page.tsx
# app/payment/success/page.tsx
# app/payment/cancel/page.tsx

# 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ sandbox
npm run dev
```

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã

- **ePoint Support**: (–Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: https://epoint.az/developers (—É—Ç–æ—á–Ω–∏—Ç—å)
- **–¢–µ—Ö. –ø–æ–¥–¥–µ—Ä–∂–∫–∞**: support@epoint.az (—É—Ç–æ—á–Ω–∏—Ç—å)

---

## ‚úÖ Checklist –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

- [x] –°–æ–∑–¥–∞–Ω–∞ –ë–î —Å—Ö–µ–º–∞
- [x] –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–¥–∞
- [x] –î–æ–±–∞–≤–ª–µ–Ω—ã environment variables
- [x] –°–æ–∑–¥–∞–Ω –ø–ª–∞–Ω –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- [ ] –ü–æ–ª—É—á–µ–Ω–∞ API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã API functions
- [ ] –°–æ–∑–¥–∞–Ω—ã payment pages
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω enroll flow
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ sandbox
- [ ] –†–∞–∑–≤–µ—Ä–Ω—É—Ç–æ –Ω–∞ production

---

**–°—Ç–∞—Ç—É—Å**: ‚è≥ –ì–æ—Ç–æ–≤–æ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, –∂–¥–µ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –æ—Ç ePoint
